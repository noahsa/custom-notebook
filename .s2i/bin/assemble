#!/bin/bash

set -x

set -eo pipefail


# Execute original assemble script.

/opt/app-root/builder/assemble

# install pycurl with nss for rhel support
pip install --compile --install-option="--with-nss" pycurl

# Activate ipywidgets extension.

# jupyter nbextension enable --py widgetsnbextension --sys-prefix

# Also activate ipywidgets/bokeh extension for JupyterLab.

jupyter labextension install @jupyter-widgets/jupyterlab-manager --no-build
# jupyter labextension install @bokeh/jupyter_bokeh --no-build

pip install jupyter-server-proxy
# jupyter labextension install @jupyterlab/server-proxy --no-build

# jupyter labextension install jupyterlab-s3-browser --no-build
pip install jupyterlab-s3-browser
jupyter serverextension enable --sys-prefix jupyterlab_s3_browser


pip install jupyterlab-git jupyterlab_execute_time

jupyter labextension install jupyterlab-topbar-extension jupyterlab-system-monitor --no-build

pip install jupyterlab-lsp jedi-language-server #'python-lsp-server[all]'


## finance requested extensions
pip install jupyter_contrib_nbextensions jupyter_nbextensions_configurator
jupyter contrib nbextension install --sys-prefix
jupyter nbextensions_configurator enable --sys-prefix


# jupyter nbextension enable execute_time/ExecuteTime
# jupyter nbextension enable collapsible_headings/main
# jupyter nbextension enable toc2/main
# jupyter nbextension enable toggle_all_line_numbers/main
# jupyter nbextension enable code_prettify/code_prettify
# jupyter labextension install jupyterlab-flake8 --no-build


jupyter lab build

# Enable bokeh extension also for single notebooks
# jupyter nbextension enable  --sys-prefix --py jupyter_bokeh

# Install facets which does not have a pip package.

cd /tmp
git clone https://github.com/PAIR-code/facets.git
cd facets
jupyter nbextension install facets-dist/ --sys-prefix
cd $HOME
rm -rf /tmp/facets

# Import matplotlib the first time to build the font cache.

MPLBACKEND=Agg python -c "import matplotlib.pyplot"


## get icons
wget https://hotio.dev/img/image-logos/rclone.svg -O /opt/app-root/share/icons/rclone.svg
wget https://upload.wikimedia.org/wikipedia/commons/9/9a/Visual_Studio_Code_1.35_icon.svg -O /opt/app-root/share/icons/vscode.svg


# Make sure the S2I source directory is empty as we will use the image
# produced to run further S2I builds

(shopt -s dotglob ; rm -rf ${APP_ROOT}/src/*)

# Fix up permissions.

fix-permissions /opt/app-root
